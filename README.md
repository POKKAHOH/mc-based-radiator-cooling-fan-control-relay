# mc-based-radiator-cooling-fan-control-relay
Automatically exported from code.google.com/p/mc-based-radiator-cooling-fan-control-relay
Autor gleb.lutskov@gmail.com
http://geektimes.ru/post/258130/

А вот кусок из переписки с одним из повторивших этот девайс — в нем впервые детально выписан алгоритм (!) — до этого писал прямо из мозга в ассемблер:
Теперь идея и реализация собственно алгоритма автоустановки (все шаги ниже соответствуют неустановленным порогам):

1. Ждем сигнала включения вентилятора от ЭСУД (либо от датчика температуры в радиаторе в варианте Геннадия) 
2. Запоминаем температуру в момент появления сигнала как T1 (реально запоминается код канала АЦП оцифровки сигнала датчика — назовем его C1) 
3. Включаем вентилятор на 100%. Ставим флаг «режим автоустановки активен (бит 3)»
4. Через 3 секунды считываем код АЦП (назовем его C1'). Это действие нужно для того, чтобы определить величину компенсации значения температуры из-за влияния тока, протекающего через вентилятор, и вызванного им падения напряжения в измерительной цепи, на оцифрованное значение температуры. Реально за 3 секунды мотор не успевает охладиться, зато вентилятор стартует и выходит на номинальный ток.
5. Вычисляем коррекцию АЦП для 100% мощности вентилятора (назовем ее K100 = C1 — C1'). Запоминаем К100.
6. Ждем снятия сигнала включения вентилятора от ЭСУД (либо отключения датчика в радиаторе). 
7. Плавно снижаем мощность с 75% до 12% примерно на 1.5% в секунду.
8. Выключаем вентилятор, ждем 60 секунд.
9. Запоминаем температуру как T2 (код АЦП С2).
10. Корректируем нижний порог (увеличиваем на 1/8 разницы между верхним и нижним), для того, чтобы он был выше термостабильной точки термостата. T2 = T2 + (T1 — T2) / 8. В кодах АЦП это C2 = C2 — (C2 — C1) / 8, т.к. напряжение на датчике с ростом температуры падает.
11. Сохраняем C1, C2, K100 во внутреннем EEPROM реле.
12. Устанавливаем флаг «пороги установлены» (бит 5), снимаем флаг «режим автоустановки активен», выходим из режима автоустановки в рабочий режим

Идея алгоритма в том, что он продувает радиатор до термостабильной точки термостата, но дует не сильно, чтобы не остужать двигатель прямым охлаждением блока и головки. Затем вентилятор выключается и реле дает мотору чуть нагреться — таким образом мы автоматически получаем точку для начала работы вентилятора.

Во время автоустановки реле воспринимает сигнал с геркона в течение шагов 7 и 8 — поднесение магнита к реле в эти моменты вызывает последовательность шагов 9, 11, 12. Коррекция порога на шаге 10 при этом не производится).

Если во время автоустановки нарушились некоторые ожидаемые реле условия, устанавливается флаг «ошибка автоконфигурации (бит 4)» и реле выходит из режима автоустановки. Чтобы реле опять смогло войти в этот режим по условию шага 1, надо выключить и включить питание реле.

Ошибки ловятся такие:
Шаг 2 — значение АЦП вне диапазона (слишком низкое или высокое). Диапазон автоконфигурации по коду АЦП 248..24 (11111000...00011000). В этом случае реле просто не входит в режим автоконфигурации без установки флага ошибки.
Шаг 4 — в течение времени ожидания 3 секунд обнаружено снятие внешнего сигнала включения вентилятора.
Шаг 7 — во время снижения оборотов обнаружен активный внешний сигнал включения вентилятора Шаг 8 — во время ожидания обнаружен активный внешний сигнал включения вентилятора Шаг 11 — установленные пороги вне диапазона 248..24, либо разница C2 — C1 < 4 (то есть они слишком близко друг к другу, либо по какой-то причине C2 > C1 — например, когда вентилятор на самом деле не срабатывает, и температура продолжает расти)

Теперь рабочий режим:

Расчет требуемой мощности (Preq)
1. Если внешний сигнал активен — Preq = 100% 2. Если неактивен, то смотрится текущий код АЦП © и соответствующая ему температура T:
T < T2 (C > C2): Preq = 0%
T > T1 (C < C1): Preq = 100%
T2 <= T <= T1 (C2 >= C >= C1): Preq = Pstart + (100% — Pstart) * (C2 — C) / (C2 — C1), где Pstart = начальная мощность (12%)

При этом, требуемая мощность не сразу подается на вентилятор, а проходит через алгоритм плавного разгона и органичения частоты пуска/останова вентилятора.
Этот алгоритм работает только в рабочем режиме и при отсутствии внешнего сигнала включения:
Пусть Pcurr — текущая мощность вентилятора 
1. Если Pcurr > 0 и Preq = 0, либо Pcurr = 0 и Preq > 0 — то есть требуется запуск остановленного или останов работающего вентилятора, то:
— Смотрится время находжения вентилятора в данном состоянии (запущен или остановлен). Если время меньше порога — состояние вентилятора не меняется. 
— При этом, если Pcurr > Pstart и Preq = 0, то на остаток времени запущенного состояния устанавливается Pcurr = Pstart (то есть вентилятор крутится на минимальных оборотах) 2. Если п.1 не выполняется, либо время нахождения в состоянии прошло, то:
— Если Preq < Pcurr, то устанавливается Pcurr = Preq (то изменение скорости вращения в сторону снижения происходит сразу, как рассчитано новое значение)
— Если Preq > Pcurr, то набор скорости вращения ограничивается сверху величиной примерно 1.5% в секунду (кроме случая, когда включение вентилятора запрашивается внешним сигналом) — то есть если Preq — Pcurr > Pdelta, то Pcurr = Pcurr + Pdelta, иначе Pcurr = Preq

Теперь про алгоритм оцифровки значения АЦП датчика и компенсации паразитной обратной связи при работе вентилятора:

При расчете мощности используется усредненное значение кода текущей температуры С (см. Расчет требуемой мощности), получаемое средним арифметическим последних 8 значений Сm1, Cm2, Cm3… Cm8. Усреднение происходит методом «скользящего окна» — то есть помещение нового значения в буфер из 8 значений выталкивает наиболее старое и вызывает пересчет среднеарифметического С. Цикл АЦП (и пересчет среднего) происходит каждые 640 мс.
«Сырое» (считанное из АЦП) значение Cadc, прежде чем попадет в буфер подсчета, участвует в следующем алгоритме:
1. Проверяется, что Cadc > Cdisc, где Cdics — макс. Значение АЦП для неподключенного измерительного вывода.
2. Если Cadc > Cdisc, то выставляется флаг «датчик не подключен (бит 6)», значение не попадает в буфер 8 последних значений, и пересчет среднего не выполняется.
3. Если Cadc >= Cdisc — то есть датчик подключен, то Сadc корректируется на определенную величину в зависимости от текущей мощности вентилятора и величины коррекции для 100% мощности (см. шаг 4 алгоритма автоустановки): Cadc = Cadc + Кcurr, где Кcurr = К100 * (Pcurr / 100%). Если при этом Кcurr > 0, то устанавливается флаг «значение АЦП скорректировано (бит 7)». Алгоритм коррекции работает только в рабочем режиме и не работает в режиме автоконфигурации.
4. Выполняется ограничение отрицательной динамики Cadc, чтобы подавить резкие снижения С из-за импульсной нагрузки в общих с датчиком температуры цепях питания автомобиля: Если C — Cadc > Сdelta, то Cadc = C — Cdelta. Ограничение не работает в течение первых 15 секунд после включения зажигания, для того, чтобы в буфере значений быстро сформировались правильные значения Cm1, Cm2...Cm8.
5. Скорректированное по мощности и динамике значение Cadc заталкивается в буфер значений для усреднения как Cm1..Cm8 в зависимости от текущего значения указателя головы буфера (буфер циклический, указатель головы принимает значения от 1 до 8).

Теперь про диагностику светодиодом:

Первый байт — это «сырой» код АЦП (в ранних версиях здесь индицировалось среднее значение C) Второй байт — слово состояния Между первым и вторым байтом пауза порядка 1.5 секунд.
Между циклами индикации пауза 3-4 секунды.
Байты индицируются побитно, начиная со старшего (бит 7, бит 6,… бит 0).
Длинная вспышка соответствует биту, установленному в «1», короткая — в «0».

Расшифровка слова состояния:
Бит 7 — значение АЦП откорректировано по текущей мощности вентилятора
Бит 6 — датчик температуры не подключен
Бит 5 — пороги установлены
Бит 4 — ошибка установки порогов
Бит 3 — режим автоконфигурации активен
Бит 2 — внутренний сброс процессора из-за зависания — нештатная ситуация
Бит 1 — внешний сигнал включения вентилятора активен
Бит 0 — режим продувки при остановке двигателя активен


